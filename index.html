<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>بازی جنگل پیکسلی</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // اندازه نقشه (ثابت، اما اسکیل می‌شه)
        const mapCells = 3;
        let cellSize = Math.min(canvas.width, canvas.height) / mapCells * 1.5; // ریسپانسیو
        const mapWidth = cellSize * mapCells;
        const mapHeight = cellSize * mapCells;

        // تصاویر رایگان مستقیم
        const playerImg = new Image();
        playerImg.src = 'https://img.itch.zone/aW1hZ2UvMjgxMDUwOC8xNjc4NTgxNi5qcGc=/original/tphitC.jpg'; // sprite sheet کاراکتر

        const treeImg = new Image();
        treeImg.src = 'https://opengameart.org/sites/default/files/free_peview_0.png'; // tileset درخت‌ها

        const marketImg = new Image();
        marketImg.src = 'https://img.craftpix.net/2025/08/Pixel-Art-Market-Square-RPG-Shop-and-NPC-Assets-Pack4-720x480.webp'; // غرفه بازار

        // کاراکتر
        let player = {
            x: mapWidth / 2,
            y: mapHeight / 2,
            size: cellSize / 5, // ریسپانسیو
            speed: cellSize / 150,
            frame: 0,
            direction: 'down' // down, up, left, right
        };
        let target = { x: player.x, y: player.y };
        let camera = { x: 0, y: 0 };

        // موجودی
        let wood = 0;
        let coins = 0;

        // درخت‌ها در جنگل بالا چپ
        const trees = [
            { x: cellSize * 0.3, y: cellSize * 0.3, collected: false },
            { x: cellSize * 0.7, y: cellSize * 0.2, collected: false },
            { x: cellSize * 0.4, y: cellSize * 0.6, collected: false },
            { x: cellSize * 0.6, y: cellSize * 0.5, collected: false }
        ];

        // کلیک/تاچ
        canvas.addEventListener('click', handleClick);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleClick(e.touches[0]);
        });

        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            target.x = e.clientX - rect.left + camera.x;
            target.y = e.clientY - rect.top + camera.y;
        }

        function updateSizes() {
            cellSize = Math.min(canvas.width, canvas.height) / mapCells * 1.5;
            player.size = cellSize / 5;
            player.speed = cellSize / 150;
            // به‌روزرسانی موقعیت درخت‌ها اگر لازم
        }

        function gameLoop() {
            updateSizes(); // برای ریسپانسیو در resize

            // حرکت
            const dx = target.x - player.x;
            const dy = target.y - player.y;
            const dist = Math.hypot(dx, dy);
            if (dist > 10) {
                player.x += (dx / dist) * player.speed;
                player.y += (dy / dist) * player.speed;
                player.frame = (player.frame + 0.2) % 4; // انیمیشن راه رفتن

                // جهت
                if (Math.abs(dx) > Math.abs(dy)) {
                    player.direction = dx > 0 ? 'right' : 'left';
                } else {
                    player.direction = dy > 0 ? 'down' : 'up';
                }
            } else {
                player.frame = 0;
            }

            // دوربین
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;
            camera.x = Math.max(0, Math.min(camera.x, mapWidth - canvas.width));
            camera.y = Math.max(0, Math.min(camera.y, mapHeight - canvas.height));

            // پاک کردن
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // background
            ctx.fillStyle = '#228B22';
            ctx.fillRect(-camera.x, -camera.y, mapWidth, mapHeight);

            // مرز خانه‌ها
            ctx.strokeStyle = '#000';
            ctx.lineWidth = cellSize / 50;
            for (let i = 0; i <= mapCells; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cellSize - camera.x, -camera.y);
                ctx.lineTo(i * cellSize - camera.x, mapHeight - camera.y);
                ctx.moveTo(-camera.x, i * cellSize - camera.y);
                ctx.lineTo(mapWidth - camera.x, i * cellSize - camera.y);
                ctx.stroke();
            }

            // درخت‌ها
            if (treeImg.complete) {
                trees.forEach(tree => {
                    if (!tree.collected) {
                        ctx.drawImage(treeImg, 100, 100, 100, 150, tree.x - camera.x - player.size/2, tree.y - camera.y - player.size, player.size * 1.5, player.size * 2);
                    }
                });
            }

            // جمع چوب
            trees.forEach(tree => {
                if (!tree.collected && Math.hypot(player.x - tree.x, player.y - tree.y) < player.size) {
                    wood += 1;
                    tree.collected = true;
                }
            });

            // بازار
            if (marketImg.complete) {
                ctx.drawImage(marketImg, cellSize * 0.2 - camera.x, mapHeight - cellSize * 0.8 - camera.y, cellSize * 0.6, cellSize * 0.5);
            }

            // فروش
            if (player.x < cellSize && player.y > mapHeight - cellSize && wood > 0) {
                coins += wood * 2;
                wood = 0;
            }

            // کاراکتر (انیمیشن ساده: row جهت در sprite sheet)
            if (playerImg.complete) {
                let row = player.direction === 'down' ? 0 : player.direction === 'up' ? 3 : player.direction === 'right' ? 2 : 1;
                let col = Math.floor(player.frame);
                ctx.drawImage(playerImg, col * 64, row * 64, 64, 64, player.x - camera.x - player.size/2, player.y - camera.y - player.size/2, player.size, player.size);
            }

            // HUD موجودی
            ctx.fillStyle = '#FFF';
            ctx.font = `${canvas.width / 20}px Arial`;
            ctx.fillText(`چوب: ${wood}   سکه: ${coins}`, 20, 50);

            requestAnimationFrame(gameLoop);
        }

        // شروع بعد لود تصاویر
        window.onload = () => {
            if (playerImg.complete && treeImg.complete && marketImg.complete) {
                gameLoop();
            } else {
                playerImg.onload = treeImg.onload = marketImg.onload = gameLoop;
            }
        };
    </script>
</body>
</html>
